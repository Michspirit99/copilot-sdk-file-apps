name: Validate Samples

on:
  workflow_dispatch: # Manual trigger only
  push:
    branches: [ master ]
    paths:
      - 'samples/**'
      - '.github/workflows/**'
  pull_request:
    branches: [ master ]
    paths:
      - 'samples/**'

jobs:
  compile-samples:
    name: Compile All Samples
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Setup .NET 10
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '10.0.x'
        dotnet-quality: 'preview'
    
    - name: Verify .NET version
      run: dotnet --version
    
    - name: Compile all samples
      run: |
        echo "üî® Compiling all sample files..."
        errors=0
        for file in samples/*.cs; do
          echo ""
          echo "=== Compiling: $file ==="
          if dotnet build "$file" 2>&1; then
            echo "‚úÖ Compiled: $file"
          else
            echo "‚ùå Compilation failed: $file"
            errors=$((errors + 1))
          fi
        done
        
        echo ""
        if [ $errors -gt 0 ]; then
          echo "‚ùå $errors sample(s) failed to compile"
          exit 1
        fi
        
        echo "‚úÖ All samples compiled successfully!"
  
  verify-structure:
    name: Verify Sample Structure
    runs-on: ubuntu-latest
    needs: compile-samples
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Verify package directives
      run: |
        echo "üì¶ Checking package directives..."
        errors=0
        
        for file in samples/*.cs; do
          echo "Checking: $file"
          
          # Check for required package directive
          if ! grep -q "#:package" "$file"; then
            echo "‚ùå Missing #:package directive: $file"
            errors=$((errors + 1))
          fi
          
          # Ensure all packages have version specifiers
          if grep "#:package" "$file" | grep -qv "@"; then
            echo "‚ùå Package missing version specifier in: $file"
            errors=$((errors + 1))
          fi
          
          # Check for Copilot SDK usage
          if grep -q "using GitHub.Copilot.SDK" "$file"; then
            echo "  ‚úÖ Uses Copilot SDK"
          fi
        done
        
        if [ $errors -gt 0 ]; then
          echo "‚ùå $errors issue(s) found"
          exit 1
        fi
        
        echo "‚úÖ All package directives valid!"
  
  validate-readme:
    name: Validate Documentation
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Check all samples are documented
      run: |
        echo "üìö Checking README documentation..."
        
        # Get all sample files
        samples=$(ls samples/*.cs | xargs -n 1 basename)
        
        echo "Sample files found:"
        echo "$samples"
        echo ""
        
        missing=0
        for sample in $samples; do
          if ! grep -q "$sample" README.md; then
            echo "‚ùå Sample not documented in README: $sample"
            missing=$((missing + 1))
          else
            echo "‚úÖ Documented: $sample"
          fi
        done
        
        if [ $missing -gt 0 ]; then
          echo ""
          echo "‚ö†Ô∏è  $missing sample(s) missing from README"
          echo "Please add documentation for all samples"
          exit 1
        fi
        
        echo ""
        echo "‚úÖ All samples are documented in README!"
    
    - name: Verify sample count matches
      run: |
        sample_count=$(ls samples/*.cs | wc -l)
        readme_sample_count=$(grep -c "samples/.*\.cs" README.md || true)
        
        echo "Sample files: $sample_count"
        echo "README references: $readme_sample_count"
        
        if [ "$readme_sample_count" -lt "$sample_count" ]; then
          echo "‚ö†Ô∏è  README may be missing some samples"
        fi
